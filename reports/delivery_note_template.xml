<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Template principal du bon de livraison -->
    <template id="report_delivery_note_document">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <!-- Vérifier que c'est bien un picking sortant avec BL -->
                <t t-if="o.picking_type_code == 'outgoing' and o.delivery_note_number">
                    <div class="page">

                        <!-- En-tête du document -->
                        <div class="row" style="border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px;">
                            <div class="col-8">
                                <h1 style="color: #2e7d32; font-weight: bold;">
                                    BON DE LIVRAISON
                                </h1>
                                <h3 style="color: #666;">
                                    N° <span t-field="o.delivery_note_number"/>
                                </h3>
                            </div>
                            <div class="col-4 text-right">
                                <img t-if="o.company_id.logo"
                                     t-att-src="image_data_uri(o.company_id.logo)"
                                     style="max-height: 80px;"
                                     alt="Logo"/>
                            </div>
                        </div>

                        <!-- Informations société et client -->
                        <div class="row" style="margin-bottom: 30px;">
                            <div class="col-6">
                                <h4 style="color: #2e7d32; border-bottom: 1px solid #2e7d32;">EXPÉDITEUR</h4>
                                <div style="margin-top: 10px;">
                                    <strong t-field="o.company_id.name"/><br/>
                                    <span t-field="o.company_id.street"/><br/>
                                    <span t-if="o.company_id.street2" t-field="o.company_id.street2"/><br/>
                                    <span t-field="o.company_id.zip"/> <span t-field="o.company_id.city"/><br/>
                                    <span t-if="o.company_id.state_id" t-field="o.company_id.state_id.name"/><br/>
                                    <span t-field="o.company_id.country_id.name"/><br/>
                                    <t t-if="o.company_id.vat">
                                        <strong>NIF:</strong> <span t-field="o.company_id.vat"/><br/>
                                    </t>
                                    <t t-if="o.company_id.phone">
                                        <strong>Tél:</strong> <span t-field="o.company_id.phone"/><br/>
                                    </t>
                                    <t t-if="o.company_id.email">
                                        <strong>Email:</strong> <span t-field="o.company_id.email"/>
                                    </t>
                                </div>
                            </div>

                            <div class="col-6">
                                <h4 style="color: #2e7d32; border-bottom: 1px solid #2e7d32;">DESTINATAIRE</h4>
                                <div style="margin-top: 10px;">
                                    <strong t-field="o.partner_id.name"/><br/>
                                    <span t-field="o.partner_id.street"/><br/>
                                    <span t-if="o.partner_id.street2" t-field="o.partner_id.street2"/><br/>
                                    <span t-field="o.partner_id.zip"/> <span t-field="o.partner_id.city"/><br/>
                                    <span t-if="o.partner_id.state_id" t-field="o.partner_id.state_id.name"/><br/>
                                    <span t-field="o.partner_id.country_id.name"/><br/>
                                    <t t-if="o.partner_id.vat">
                                        <strong>NIF:</strong> <span t-field="o.partner_id.vat"/><br/>
                                    </t>
                                    <t t-if="o.partner_id.phone">
                                        <strong>Tél:</strong> <span t-field="o.partner_id.phone"/>
                                    </t>
                                </div>
                            </div>
                        </div>

                        <!-- Informations du document -->
                        <div class="row" style="margin-bottom: 20px; background-color: #f5f5f5; padding: 15px;">
                            <div class="col-6">
                                <strong>Date BL:</strong> <span t-field="o.delivery_note_date" t-options="{'widget': 'date'}"/><br/>
                                <strong>Date Livraison:</strong> <span t-field="o.scheduled_date" t-options="{'widget': 'date'}"/><br/>
                                <t t-if="o.sale_id">
                                    <strong>Commande:</strong> <span t-field="o.sale_id.name"/><br/>
                                    <strong>Date Commande:</strong> <span t-field="o.sale_id.date_order" t-options="{'widget': 'date'}"/>
                                </t>
                            </div>
                            <div class="col-6">
                                <strong>Responsable:</strong> <span t-field="o.user_id.name"/><br/>
                                <strong>Mode de Livraison:</strong> <span t-field="o.carrier_id.name" t-if="o.carrier_id"/><br/>
                                <strong>État:</strong>
                                <span t-if="o.state == 'done'" style="color: green;">✓ Livré</span>
                                <span t-elif="o.state == 'cancel'" style="color: red;">✗ Annulé</span>
                                <span t-else="o.state" style="color: orange;">⏳ En cours</span>
                            </div>
                        </div>

                        <!-- Tableau des produits -->
                        <table class="table table-sm" style="border: 1px solid #000;">
                            <thead style="background-color: #2e7d32; color: white;">
                                <tr>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: center;">N°</th>
                                    <th style="border: 1px solid #000; padding: 8px;">DÉSIGNATION</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: center;">UNITÉ</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: center;">QTÉ COMMANDÉE</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: center;">QTÉ LIVRÉE</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: right;">PRIX UNIT. (DA)</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: center;">REMISE %</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: right;">MONTANT (DA)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-set="line_num" t-value="0"/>
                                <tr t-foreach="o.move_ids_without_package" t-as="move">
                                    <t t-if="move.state != 'cancel'">
                                        <t t-set="line_num" t-value="line_num + 1"/>
                                        <t t-set="qty_ordered" t-value="move.sale_line_id.product_uom_qty if move.sale_line_id else move.product_uom_qty"/>
                                        <t t-set="qty_delivered" t-value="move.quantity_done if move.quantity_done else move.product_uom_qty"/>

                                        <td style="border: 1px solid #000; padding: 5px; text-align: center;">
                                            <span t-esc="line_num"/>
                                        </td>
                                        <td style="border: 1px solid #000; padding: 5px;">
                                            <strong t-field="move.product_id.name"/><br/>
                                            <small t-if="move.product_id.default_code">
                                                Réf: <span t-field="move.product_id.default_code"/>
                                            </small>
                                        </td>
                                        <td style="border: 1px solid #000; padding: 5px; text-align: center;">
                                            <span t-field="move.product_uom.name"/>
                                        </td>
                                        <td style="border: 1px solid #000; padding: 5px; text-align: center;">
                                            <span t-esc="'{:,.2f}'.format(qty_ordered)"/>
                                        </td>
                                        <td style="border: 1px solid #000; padding: 5px; text-align: center; background-color: #e8f5e8;">
                                            <strong t-esc="'{:,.2f}'.format(qty_delivered)"/>
                                        </td>
                                        <td style="border: 1px solid #000; padding: 5px; text-align: right;">
                                            <span t-esc="'{:,.2f}'.format(move.price_unit)"/>
                                        </td>
                                        <td style="border: 1px solid #000; padding: 5px; text-align: center;">
                                            <span t-esc="'{:.1f}'.format(move.discount)"/>%
                                        </td>
                                        <td style="border: 1px solid #000; padding: 5px; text-align: right;">
                                            <strong t-esc="'{:,.2f}'.format(move.price_subtotal)"/>
                                        </td>
                                    </t>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Totaux -->
                        <div class="row" style="margin-top: 20px;">
                            <div class="col-6">
                                <!-- Informations complémentaires -->
                                <div style="border: 1px solid #000; padding: 10px;">
                                    <h5 style="color: #2e7d32;">OBSERVATIONS</h5>
                                    <p t-field="o.note" style="min-height: 40px;"/>

                                    <t t-if="o.sale_id and o.sale_id.note">
                                        <h6>Note Commande:</h6>
                                        <p t-field="o.sale_id.note"/>
                                    </t>
                                </div>
                            </div>

                            <div class="col-6">
                                <!-- Récapitulatif des montants -->
                                <table class="table table-sm" style="border: 1px solid #000;">
                                    <tr>
                                        <td style="border: 1px solid #000; padding: 8px; background-color: #f5f5f5;">
                                            <strong>MONTANT HT</strong>
                                        </td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">
                                            <strong t-esc="'{:,.2f} DA'.format(o.amount_untaxed)"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #000; padding: 8px; background-color: #f5f5f5;">
                                            <strong>TVA</strong>
                                        </td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">
                                            <strong t-esc="'{:,.2f} DA'.format(o.amount_tax)"/>
                                        </td>
                                    </tr>
                                    <tr style="background-color: #2e7d32; color: white;">
                                        <td style="border: 1px solid #000; padding: 8px;">
                                            <strong>TOTAL TTC</strong>
                                        </td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">
                                            <strong t-esc="'{:,.2f} DA'.format(o.amount_total)"/>
                                        </td>
                                    </tr>
                                </table>

                                <!-- États financiers -->
                                <div style="margin-top: 10px; padding: 8px; border: 1px solid #000; background-color: #f9f9f9;">
                                    <small>
                                        <strong>État Facturation:</strong>
                                        <span t-if="o.sale_invoice_status == 'invoiced'" style="color: green;">✓ Facturé</span>
                                        <span t-elif="o.sale_invoice_status == 'to invoice'" style="color: orange;">⏳ À Facturer</span>
                                        <span t-else="o.sale_invoice_status" style="color: red;">✗ Non Facturé</span>
                                        <br/>
                                        <strong>État Paiement:</strong>
                                        <span t-if="o.sale_payment_state == 'paid'" style="color: green;">✓ Payé</span>
                                        <span t-elif="o.sale_payment_state == 'partial'" style="color: orange;">⏳ Partiel</span>
                                        <span t-elif="o.sale_payment_state == 'in_payment'" style="color: orange;">⏳ En Cours</span>
                                        <span t-else="o.sale_payment_state" style="color: red;">✗ Non Payé</span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Signatures -->
                        <div class="row" style="margin-top: 40px; border-top: 1px solid #000; padding-top: 20px;">
                            <div class="col-4 text-center">
                                <strong>LIVREUR</strong><br/>
                                <div style="height: 60px; border-bottom: 1px solid #000; margin: 10px 0;"></div>
                                <small>Nom et Signature</small>
                            </div>
                            <div class="col-4 text-center">
                                <strong>RESPONSABLE STOCK</strong><br/>
                                <div style="height: 60px; border-bottom: 1px solid #000; margin: 10px 0;"></div>
                                <small>Nom et Signature</small>
                            </div>
                            <div class="col-4 text-center">
                                <strong>CLIENT</strong><br/>
                                <div style="height: 60px; border-bottom: 1px solid #000; margin: 10px 0;"></div>
                                <small>Nom, Cachet et Signature</small>
                            </div>
                        </div>

                        <!-- Pied de page -->
                        <div style="position: fixed; bottom: 20px; left: 0; right: 0; text-align: center; border-top: 1px solid #ccc; padding-top: 10px;">
                            <small style="color: #666;">
                                Document généré automatiquement par CPSS -
                                <span t-esc="context_timestamp(datetime.datetime.now()).strftime('%d/%m/%Y à %H:%M')"/>
                            </small>
                        </div>

                    </div>
                </t>
            </t>
        </t>
    </template>

</odoo>